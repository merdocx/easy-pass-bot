{% extends "base.html" %}

{% block title %}Просмотр пропусков - Easy Pass Admin{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <div class="header-left">
            <h1><i class="fas fa-car"></i> Просмотр пропусков</h1>
            <p>Информация о всех пропусках в системе</p>
        </div>
        <div class="header-right">
            <a href="/logout" class="btn btn-secondary">
                <i class="fas fa-sign-out-alt"></i>
                Выйти
            </a>
        </div>
    </header>
    
    <nav class="dashboard-nav">
        <a href="/dashboard" class="nav-item">
            <i class="fas fa-tachometer-alt"></i>
            <span>Главная</span>
        </a>
        <a href="/users" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Пользователи</span>
        </a>
        <a href="/passes" class="nav-item active">
            <i class="fas fa-car"></i>
            <span>Пропуски</span>
        </a>
    </nav>
    
    <main class="dashboard-content">

        <!-- Статистика -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ total_passes }}</div>
                <div class="stat-label">Всего пропусков</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ active_passes }}</div>
                <div class="stat-label">Активные</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ used_passes }}</div>
                <div class="stat-label">Использованы</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ cancelled_passes }}</div>
                <div class="stat-label">Отменены</div>
            </div>
        </div>
        
        
        <!-- Таблица пропусков -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Номер авто</th>
                        <th>Владелец</th>
                        <th>Телефон</th>
                        <th>Квартира</th>
                        <th>Статус</th>
                        <th>Дата создания</th>
                        <th>Дата использования</th>
                        <th>Архив</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in passes_with_users %}
                    {% set pass = item.pass %}
                    {% set user = item.user %}
                    <tr>
                        <td>{{ pass.id }}</td>
                        <td>
                            <span class="car-number">{{ pass.car_number }}</span>
                        </td>
                        <td>
                            {% if user %}
                                {{ user.full_name }}
                            {% else %}
                                <span class="text-muted">Пользователь не найден</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user %}
                                {{ user.phone_number }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user and user.apartment %}
                                {{ user.apartment }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge status-{{ pass.status }}">
                                {% if pass.status == 'active' %}
                                    <i class="fas fa-check-circle"></i> Активен
                                {% elif pass.status == 'used' %}
                                    <i class="fas fa-history"></i> Использован
                                {% else %}
                                    <i class="fas fa-ban"></i> Отменен
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            {% if pass.created_at %}
                                {% set date_str = pass.created_at|string %}
                                {% if ' ' in date_str %}
                                    {{ date_str.split(' ')[0] }} {{ date_str.split(' ')[1].split(':')[0] }}:{{ date_str.split(' ')[1].split(':')[1] }}
                                {% elif 'T' in date_str %}
                                    {{ date_str.split('T')[0] }} {{ date_str.split('T')[1].split(':')[0] }}:{{ date_str.split('T')[1].split(':')[1] }}
                                {% else %}
                                    {{ date_str }}
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if pass.used_at %}
                                {{ pass.used_at }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pass.is_archived %}
                                <span class="badge badge-archived" title="В архиве">
                                    <i class="fas fa-archive"></i>
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Индикатор загрузки для infinite scroll -->
            <div id="loading-indicator" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <span>Загрузка пропусков...</span>
            </div>
            
            {% if not passes_with_users %}
            <div class="empty-state">
                <i class="fas fa-car"></i>
                <h3>Пропуски не найдены</h3>
                <p>В системе пока нет созданных пропусков</p>
            </div>
            {% endif %}
        </div>
        
    </main>
</div>

<script>
// Infinite Scroll для пропусков
let isLoading = false;
let currentOffset = 20; // Начинаем с 20, так как первые 20 уже загружены
let hasMoreData = {{ has_more|tojson }}; // Переменная из шаблона

async function loadMorePasses() {
    if (isLoading || !hasMoreData) return;
    
    isLoading = true;
    const loadingIndicator = document.getElementById('loading-indicator');
    loadingIndicator.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/passes?offset=${currentOffset}&limit=20`);
        const data = await response.json();
        
        if (data.passes_with_users && data.passes_with_users.length > 0) {
            const tableBody = document.querySelector('.data-table tbody');
            
            data.passes_with_users.forEach(item => {
                const row = createPassRow(item.pass, item.user);
                tableBody.appendChild(row);
            });
            
            currentOffset += data.passes_with_users.length;
            hasMoreData = data.has_more;
        } else {
            hasMoreData = false;
        }
    } catch (error) {
        console.error('Ошибка загрузки пропусков:', error);
    } finally {
        isLoading = false;
        loadingIndicator.style.display = 'none';
    }
}

function createPassRow(pass, user) {
    const row = document.createElement('tr');
    
    // Определяем статус пропуска
    let statusHtml = '';
    if (pass.status === 'active') {
        statusHtml = '<span class="status-badge status-active"><i class="fas fa-check-circle"></i> Активный</span>';
    } else if (pass.status === 'used') {
        statusHtml = '<span class="status-badge status-used"><i class="fas fa-check"></i> Использован</span>';
    } else if (pass.status === 'cancelled') {
        statusHtml = '<span class="status-badge status-cancelled"><i class="fas fa-times"></i> Отменен</span>';
    }
    
    // Определяем архивный статус
    let archiveHtml = '';
    if (pass.is_archived) {
        archiveHtml = '<span class="status-badge status-archived"><i class="fas fa-archive"></i> Архивирован</span>';
    } else {
        archiveHtml = '<span class="status-badge status-active"><i class="fas fa-folder-open"></i> Активный</span>';
    }
    
    row.innerHTML = `
        <td>${pass.id}</td>
        <td>${pass.car_number}</td>
        <td>${user ? user.full_name : 'Неизвестно'}</td>
        <td>${user ? user.phone_number : '-'}</td>
        <td>${user ? (user.apartment || '-') : '-'}</td>
        <td>${statusHtml}</td>
        <td>${pass.created_at || '-'}</td>
        <td>${pass.used_at || '-'}</td>
        <td>${archiveHtml}</td>
    `;
    
    return row;
}

// Обработчик скролла
window.addEventListener('scroll', () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
        loadMorePasses();
    }
});

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Можно добавить дополнительную инициализацию при необходимости
});
</script>

{% endblock %}
