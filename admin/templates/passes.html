{% extends "base.html" %}

{% block title %}Просмотр пропусков - Easy Pass Admin{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <div class="header-left">
            <h1><i class="fas fa-car"></i> Просмотр пропусков</h1>
            <p>Информация о всех пропусках в системе</p>
        </div>
        <div class="header-right">
            <a href="/logout" class="btn btn-secondary">
                <i class="fas fa-sign-out-alt"></i>
                Выйти
            </a>
        </div>
    </header>
    
    <nav class="dashboard-nav">
        <a href="/dashboard" class="nav-item">
            <i class="fas fa-tachometer-alt"></i>
            <span>Главная</span>
        </a>
        <a href="/users" class="nav-item">
            <i class="fas fa-users"></i>
            <span>Пользователи</span>
        </a>
        <a href="/passes" class="nav-item active">
            <i class="fas fa-car"></i>
            <span>Пропуски</span>
        </a>
    </nav>
    
    <main class="dashboard-content">
        <!-- Статистика -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ total_passes }}</div>
                <div class="stat-label">Всего пропусков</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ active_passes }}</div>
                <div class="stat-label">Активные</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ used_passes }}</div>
                <div class="stat-label">Использованы</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ cancelled_passes }}</div>
                <div class="stat-label">Отменены</div>
            </div>
        </div>
        
        <!-- Фильтры и поиск -->
        <div class="filters-section">
            <form method="get" class="filters-form" id="searchForm">
                <div class="filter-group">
                    <input type="text" name="search" placeholder="Поиск по номеру автомобиля..." 
                           value="{{ search }}" class="search-input" id="searchInput">
                </div>
                <div class="filter-group">
                    <select name="status_filter" class="filter-select" id="statusFilter">
                        <option value="">Все статусы</option>
                        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Активные</option>
                        <option value="used" {% if status_filter == 'used' %}selected{% endif %}>Использованы</option>
                        <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Отменены</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <div class="search-status" id="searchStatus">
                        <i class="fas fa-search"></i>
                        <span>Поиск автоматический</span>
                    </div>
                    <a href="/passes" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Сбросить
                    </a>
                </div>
            </form>
        </div>
        
        <!-- Таблица пропусков -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Номер авто</th>
                        <th>Владелец</th>
                        <th>Телефон</th>
                        <th>Квартира</th>
                        <th>Статус</th>
                        <th>Дата создания</th>
                        <th>Дата использования</th>
                        <th>Использован кем</th>
                        <th>Архив</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in passes_with_users %}
                    {% set pass = item.pass %}
                    {% set user = item.user %}
                    <tr>
                        <td>{{ pass.id }}</td>
                        <td>
                            <span class="car-number">{{ pass.car_number }}</span>
                        </td>
                        <td>
                            {% if user %}
                                {{ user.full_name }}
                            {% else %}
                                <span class="text-muted">Пользователь не найден</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user %}
                                {{ user.phone_number }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user and user.apartment %}
                                {{ user.apartment }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge status-{{ pass.status }}">
                                {% if pass.status == 'active' %}
                                    <i class="fas fa-check-circle"></i> Активен
                                {% elif pass.status == 'used' %}
                                    <i class="fas fa-history"></i> Использован
                                {% else %}
                                    <i class="fas fa-ban"></i> Отменен
                                {% endif %}
                            </span>
                        </td>
                        <td>{{ pass.created_at if pass.created_at else '-' }}</td>
                        <td>
                            {% if pass.used_at %}
                                {{ pass.used_at }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pass.used_by_id %}
                                ID: {{ pass.used_by_id }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pass.is_archived %}
                                <span class="badge badge-archived">
                                    <i class="fas fa-archive"></i> В архиве
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if not passes_with_users %}
            <div class="empty-state">
                <i class="fas fa-car"></i>
                <h3>Пропуски не найдены</h3>
                <p>Попробуйте изменить параметры поиска или фильтры</p>
            </div>
            {% endif %}
        </div>
    </main>
</div>

<script>
// Автоматический поиск с debounce
let searchTimeout;
function performSearch() {
    const form = document.getElementById('searchForm');
    const searchStatus = document.getElementById('searchStatus');
    
    // Показываем индикатор поиска
    searchStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Поиск...</span>';
    
    // Отправляем форму
    form.submit();
}

// Debounce функция для поиска
function debounceSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(performSearch, 500); // 500ms задержка
}

// Обработчики событий для автоматического поиска
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    
    // Поиск по вводу текста
    searchInput.addEventListener('input', debounceSearch);
    
    // Поиск при изменении фильтров
    statusFilter.addEventListener('change', performSearch);
});
</script>
{% endblock %}
