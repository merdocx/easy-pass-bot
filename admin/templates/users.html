{% extends "base.html" %}

{% block title %}Управление пользователями - Easy Pass Admin{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <div class="header-left">
            <h1><i class="fas fa-users"></i> Управление пользователями</h1>
            <p>Просмотр и управление всеми пользователями системы</p>
        </div>
        <div class="header-right">
            <a href="/logout" class="btn btn-secondary">
                <i class="fas fa-sign-out-alt"></i>
                Выйти
            </a>
        </div>
    </header>
    
    <nav class="dashboard-nav">
        <a href="/dashboard" class="nav-item">
            <i class="fas fa-tachometer-alt"></i>
            <span>Главная</span>
        </a>
        <a href="/users" class="nav-item active">
            <i class="fas fa-users"></i>
            <span>Пользователи</span>
        </a>
        <a href="/passes" class="nav-item">
            <i class="fas fa-car"></i>
            <span>Пропуски</span>
        </a>
    </nav>
    
    <main class="dashboard-content">

        <!-- Статистика -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ total_users }}</div>
                <div class="stat-label">Всего пользователей</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ pending_users }}</div>
                <div class="stat-label">Ожидают подтверждения</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ approved_users }}</div>
                <div class="stat-label">Подтверждены</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ rejected_users }}</div>
                <div class="stat-label">Отклонены</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ blocked_users }}</div>
                <div class="stat-label">Заблокированы</div>
            </div>
        </div>
        
        <!-- Поиск -->
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Поиск по ФИО, телефону, квартире, Telegram ID или ID пользователя..." 
                       value="">
                <button type="button" id="clear-search" class="clear-search-btn" title="Очистить поиск" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-info" id="search-info" style="display: none;">
                <span id="search-results-count">0</span> результатов найдено
                <button type="button" id="clear-search-results" class="clear-search-btn-small">Очистить</button>
            </div>
        </div>
        
        <!-- Таблица пользователей -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Telegram ID</th>
                        <th>ФИО</th>
                        <th>Телефон</th>
                        <th>Квартира</th>
                        <th>Роль</th>
                        <th>Статус</th>
                        <th>Дата регистрации</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.telegram_id }}</td>
                        <td>{{ user.full_name }}</td>
                        <td>{{ user.phone_number }}</td>
                        <td>{{ user.apartment or '-' }}</td>
                        <td>
                            <span class="role-badge role-{{ user.role }}">
                                {% if user.role == 'admin' %}
                                    <i class="fas fa-crown"></i> Админ
                                {% elif user.role == 'security' %}
                                    <i class="fas fa-shield-alt"></i> Охрана
                                {% else %}
                                    <i class="fas fa-user"></i> Житель
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-{{ user.status }}">
                                {% if user.status == 'approved' %}
                                    <i class="fas fa-check"></i> Подтвержден
                                {% elif user.status == 'pending' %}
                                    <i class="fas fa-clock"></i> Ожидает
                                {% elif user.status == 'blocked' %}
                                    <i class="fas fa-ban"></i> Заблокирован
                                    {% if user.blocked_until %}
                                        <br><small>до {{ user.blocked_until }}</small>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-times"></i> Отклонен
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            {% if user.created_at %}
                                {% set date_str = user.created_at|string %}
                                {% if ' ' in date_str %}
                                    {{ date_str.split(' ')[0] }} {{ date_str.split(' ')[1].split(':')[0] }}:{{ date_str.split(' ')[1].split(':')[1] }}
                                {% elif 'T' in date_str %}
                                    {{ date_str.split('T')[0] }} {{ date_str.split('T')[1].split(':')[0] }}:{{ date_str.split('T')[1].split(':')[1] }}
                                {% else %}
                                    {{ date_str }}
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="actions">
                            {% if user.status == 'pending' %}
                            <!-- Ожидает: Принять и Отклонить -->
                            <form method="post" action="/users/{{ user.id }}/status" class="inline-form">
                                <input type="hidden" name="status" value="approved">
                                <button type="submit" class="btn btn-sm btn-success" title="Принять">
                                    <i class="fas fa-check"></i>
                                </button>
                            </form>
                            <form method="post" action="/users/{{ user.id }}/status" class="inline-form">
                                <input type="hidden" name="status" value="rejected">
                                <button type="submit" class="btn btn-sm btn-danger" title="Отклонить">
                                    <i class="fas fa-times"></i>
                                </button>
                            </form>
                            
                            {% elif user.status == 'rejected' %}
                            <!-- Отклонен: Удалить -->
                            <form method="post" action="/users/{{ user.id }}/delete" class="inline-form">
                                <button type="submit" class="btn btn-sm btn-danger" title="Удалить" 
                                        onclick="return confirm('Вы уверены, что хотите удалить этого пользователя? Это действие нельзя отменить!')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            
                            {% elif user.status == 'approved' %}
                            <!-- Подтвержден: Удалить, Заблокировать и Изменить роль -->
                            <form method="post" action="/users/{{ user.id }}/delete" class="inline-form">
                                <button type="submit" class="btn btn-sm btn-danger" title="Удалить"
                                        onclick="return confirm('Вы уверены, что хотите удалить этого пользователя? Это действие нельзя отменить!')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            <button type="button" class="btn btn-sm btn-warning" title="Заблокировать"
                                    onclick="showBlockModal({{ user.id }}, '{{ user.full_name }}')">
                                <i class="fas fa-ban"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-info" title="Изменить роль"
                                    onclick="showRoleModal({{ user.id }}, '{{ user.full_name }}', '{{ user.role }}')">
                                <i class="fas fa-user-cog"></i>
                            </button>
                            
                            {% elif user.status == 'blocked' %}
                            <!-- Заблокирован: Разблокировать, Удалить и Изменить роль -->
                            <form method="post" action="/users/{{ user.id }}/unblock" class="inline-form">
                                <button type="submit" class="btn btn-sm btn-success" title="Разблокировать">
                                    <i class="fas fa-unlock"></i>
                                </button>
                            </form>
                            <form method="post" action="/users/{{ user.id }}/delete" class="inline-form">
                                <button type="submit" class="btn btn-sm btn-danger" title="Удалить"
                                        onclick="return confirm('Вы уверены, что хотите удалить этого пользователя? Это действие нельзя отменить!')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            <button type="button" class="btn btn-sm btn-info" title="Изменить роль"
                                    onclick="showRoleModal({{ user.id }}, '{{ user.full_name }}', '{{ user.role }}')">
                                <i class="fas fa-user-cog"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Индикатор загрузки для infinite scroll -->
            <div id="loading-indicator" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <span>Загрузка пользователей...</span>
            </div>
            
            {% if not users %}
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h3>Пользователи не найдены</h3>
                <p>В системе пока нет зарегистрированных пользователей</p>
            </div>
            {% endif %}
        </div>
    </main>
</div>

<!-- Модальное окно для блокировки -->
<div id="blockModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Блокировка пользователя</h3>
            <span class="close" onclick="closeBlockModal()">&times;</span>
        </div>
        <form id="blockForm" method="post">
            <div class="modal-body">
                <p>Пользователь: <strong id="userName"></strong></p>
                
                <div class="form-group">
                    <label for="blockedUntil">Срок блокировки:</label>
                    <input type="date" id="blockedUntil" name="blocked_until" required>
                </div>
                
                <div class="form-group">
                    <label for="blockReason">Причина блокировки:</label>
                    <textarea id="blockReason" name="block_reason" rows="3" required 
                              placeholder="Укажите причину блокировки..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBlockModal()">Отмена</button>
                <button type="submit" class="btn btn-warning">Заблокировать</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно для изменения роли -->
<div id="roleModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Изменение роли пользователя</h3>
            <span class="close" onclick="closeRoleModal()">&times;</span>
        </div>
        <form id="roleForm" method="post">
            <div class="modal-body">
                <p>Пользователь: <strong id="roleUserName"></strong></p>
                <p>Текущая роль: <strong id="currentRole"></strong></p>
                
                <div class="form-group">
                    <label for="newRole">Новая роль:</label>
                    <select id="newRole" name="new_role" required>
                        <option value="">Выберите роль</option>
                        <option value="resident">Житель</option>
                        <option value="security">Охрана</option>
                        <option value="admin">Администратор</option>
                    </select>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Внимание!</strong> Изменение роли повлияет на права доступа пользователя в системе.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRoleModal()">Отмена</button>
                <button type="submit" class="btn btn-primary">Изменить роль</button>
            </div>
        </form>
    </div>
</div>

<script>
// Подтверждение действий
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const statusInput = this.querySelector('input[name="status"]');
        if (statusInput) {
            const status = statusInput.value;
            const action = status === 'approved' ? 'подтвердить' : 'отклонить';
            
            if (!confirm(`Вы уверены, что хотите ${action} этого пользователя?`)) {
                e.preventDefault();
            }
        }
    });
});

// Функции для модального окна блокировки
function showBlockModal(userId, userName) {
    const modal = document.getElementById('blockModal');
    const form = document.getElementById('blockForm');
    const userNameElement = document.getElementById('userName');
    
    userNameElement.textContent = userName;
    form.action = `/users/${userId}/block`;
    
    // Установить минимальную дату (завтра)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('blockedUntil').min = tomorrow.toISOString().split('T')[0];
    
    // Показать модальное окно с анимацией
    modal.style.display = 'flex';
    // Небольшая задержка для плавной анимации
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // Предотвратить прокрутку фона
    document.body.style.overflow = 'hidden';
}

function closeBlockModal() {
    const modal = document.getElementById('blockModal');
    
    // Добавляем класс closing для анимации закрытия
    modal.classList.add('closing');
    
    // Ждем завершения анимации перед скрытием
    setTimeout(() => {
        modal.style.display = 'none';
        modal.classList.remove('closing');
        document.getElementById('blockForm').reset();
        // Восстанавливаем прокрутку фона
        document.body.style.overflow = 'auto';
    }, 300);
}

// Закрытие модального окна при клике вне его
window.onclick = function(event) {
    const blockModal = document.getElementById('blockModal');
    const roleModal = document.getElementById('roleModal');
    
    if (event.target === blockModal) {
        closeBlockModal();
    } else if (event.target === roleModal) {
        closeRoleModal();
    }
}

// Функции для модального окна изменения роли
function showRoleModal(userId, userName, currentRole) {
    const modal = document.getElementById('roleModal');
    const form = document.getElementById('roleForm');
    const userNameElement = document.getElementById('roleUserName');
    const currentRoleElement = document.getElementById('currentRole');
    const newRoleSelect = document.getElementById('newRole');
    
    userNameElement.textContent = userName;
    
    // Показываем текущую роль в понятном формате
    const roleNames = {
        'resident': 'Житель',
        'security': 'Охрана', 
        'admin': 'Администратор'
    };
    currentRoleElement.textContent = roleNames[currentRole] || currentRole;
    
    form.action = `/users/${userId}/role`;
    
    // Сбрасываем выбор новой роли
    newRoleSelect.value = '';
    
    // Показываем модальное окно
    modal.style.display = 'flex';
    
    // Предотвратить прокрутку фона
    document.body.style.overflow = 'hidden';
}

function closeRoleModal() {
    const modal = document.getElementById('roleModal');
    
    // Добавляем класс closing для анимации закрытия
    modal.classList.add('closing');
    
    // Ждем завершения анимации перед скрытием
    setTimeout(() => {
        modal.style.display = 'none';
        modal.classList.remove('closing');
        document.getElementById('roleForm').reset();
        // Восстанавливаем прокрутку фона
        document.body.style.overflow = 'auto';
    }, 300);
}

// Поиск и Infinite Scroll для пользователей
let isLoading = false;
let currentOffset = 20; // Начинаем с 20, так как первые 20 уже загружены
let hasMoreData = {{ has_more|tojson }}; // Переменная из шаблона
let currentSearchTerm = ''; // Текущий поисковый запрос
let isSearchMode = false; // Режим поиска

// Функция форматирования даты
function formatDateTime(dateString) {
    if (!dateString) return '-';
    
    let dateStr = dateString.toString();
    
    // Обработка формата "2025-09-11T16:45:28.541550"
    if (dateStr.includes('T')) {
        const [date, time] = dateStr.split('T');
        const timeOnly = time.split('.')[0]; // Убираем микросекунды
        const [hours, minutes] = timeOnly.split(':');
        return `${date} ${hours}:${minutes}`;
    }
    
    // Обработка формата "2025-09-11 16:45:28"
    if (dateStr.includes(' ')) {
        const [date, time] = dateStr.split(' ');
        const [hours, minutes] = time.split(':');
        return `${date} ${hours}:${minutes}`;
    }
    
    return dateStr; // Возвращаем как есть, если формат неизвестен
}

// Поиск пользователей
async function searchUsers(searchTerm) {
    if (!searchTerm || !searchTerm.trim()) {
        // Если поиск пустой, показываем все пользователи
        clearSearch();
        return;
    }
    
    currentSearchTerm = searchTerm.trim();
    isSearchMode = true;
    currentOffset = 0; // Сбрасываем offset для поиска
    
    // Очищаем таблицу
    const tableBody = document.querySelector('.data-table tbody');
    tableBody.innerHTML = '';
    
    // Показываем индикатор загрузки
    const loadingIndicator = document.getElementById('loading-indicator');
    loadingIndicator.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/users?offset=0&limit=100&search=${encodeURIComponent(currentSearchTerm)}`);
        const data = await response.json();
        
        if (data.users && data.users.length > 0) {
            data.users.forEach(user => {
                const row = createUserRow(user);
                tableBody.appendChild(row);
            });
            
            // Обновляем информацию о результатах поиска
            document.getElementById('search-results-count').textContent = data.total_count;
            document.getElementById('search-info').style.display = 'block';
            
            currentOffset = data.users.length;
            hasMoreData = data.has_more;
        } else {
            // Показываем сообщение о том, что ничего не найдено
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #666;">По вашему запросу ничего не найдено</td></tr>';
            document.getElementById('search-info').style.display = 'none';
            hasMoreData = false;
        }
    } catch (error) {
        console.error('Ошибка поиска пользователей:', error);
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem; color: #dc3545;">Ошибка при выполнении поиска</td></tr>';
    } finally {
        loadingIndicator.style.display = 'none';
    }
}

// Очистка поиска
function clearSearch() {
    currentSearchTerm = '';
    isSearchMode = false;
    currentOffset = 20;
    hasMoreData = {{ has_more|tojson }};
    
    // Очищаем поле поиска
    document.getElementById('search-input').value = '';
    document.getElementById('clear-search').style.display = 'none';
    document.getElementById('search-info').style.display = 'none';
    
    // Перезагружаем страницу для показа всех пользователей
    window.location.reload();
}

async function loadMoreUsers() {
    if (isLoading || !hasMoreData || isSearchMode) return; // Не подгружаем в режиме поиска
    
    isLoading = true;
    const loadingIndicator = document.getElementById('loading-indicator');
    loadingIndicator.style.display = 'flex';
    
    try {
        const response = await fetch(`/api/users?offset=${currentOffset}&limit=20`);
        const data = await response.json();
        
        if (data.users && data.users.length > 0) {
            const tableBody = document.querySelector('.data-table tbody');
            
            data.users.forEach(user => {
                const row = createUserRow(user);
                tableBody.appendChild(row);
            });
            
            currentOffset += data.users.length;
            hasMoreData = data.has_more;
        } else {
            hasMoreData = false;
        }
    } catch (error) {
        console.error('Ошибка загрузки пользователей:', error);
    } finally {
        isLoading = false;
        loadingIndicator.style.display = 'none';
    }
}

function createUserRow(user) {
    const row = document.createElement('tr');
    
    // Определяем роль
    let roleHtml = '';
    if (user.role === 'admin') {
        roleHtml = '<span class="role-badge role-admin"><i class="fas fa-crown"></i> Админ</span>';
    } else if (user.role === 'security') {
        roleHtml = '<span class="role-badge role-security"><i class="fas fa-shield-alt"></i> Охрана</span>';
    } else {
        roleHtml = '<span class="role-badge role-resident"><i class="fas fa-user"></i> Житель</span>';
    }
    
    // Определяем статус
    let statusHtml = '';
    if (user.status === 'approved') {
        statusHtml = '<span class="status-badge status-approved"><i class="fas fa-check"></i> Подтвержден</span>';
    } else if (user.status === 'pending') {
        statusHtml = '<span class="status-badge status-pending"><i class="fas fa-clock"></i> Ожидает</span>';
    } else if (user.status === 'blocked') {
        statusHtml = `<span class="status-badge status-blocked"><i class="fas fa-ban"></i> Заблокирован${user.blocked_until ? '<br><small>до ' + user.blocked_until + '</small>' : ''}</span>`;
    } else {
        statusHtml = '<span class="status-badge status-rejected"><i class="fas fa-times"></i> Отклонен</span>';
    }
    
    // Определяем действия
    let actionsHtml = '';
    if (user.status === 'pending') {
        actionsHtml = `
            <form method="post" action="/users/${user.id}/status" class="inline-form">
                <input type="hidden" name="status" value="approved">
                <button type="submit" class="btn btn-sm btn-success" title="Принять">
                    <i class="fas fa-check"></i>
                </button>
            </form>
            <form method="post" action="/users/${user.id}/status" class="inline-form">
                <input type="hidden" name="status" value="rejected">
                <button type="submit" class="btn btn-sm btn-danger" title="Отклонить">
                    <i class="fas fa-times"></i>
                </button>
            </form>
        `;
    } else if (user.status === 'approved') {
        actionsHtml = `
            <button class="btn btn-sm btn-warning" onclick="openBlockModal(${user.id}, '${user.full_name}')" title="Заблокировать">
                <i class="fas fa-ban"></i>
            </button>
            <button type="button" class="btn btn-sm btn-info" title="Изменить роль"
                    onclick="showRoleModal(${user.id}, '${user.full_name}', '${user.role}')">
                <i class="fas fa-user-cog"></i>
            </button>
        `;
    } else if (user.status === 'blocked') {
        actionsHtml = `
            <form method="post" action="/users/${user.id}/unblock" class="inline-form">
                <button type="submit" class="btn btn-sm btn-success" title="Разблокировать">
                    <i class="fas fa-unlock"></i>
                </button>
            </form>
            <form method="post" action="/users/${user.id}/delete" class="inline-form">
                <button type="submit" class="btn btn-sm btn-danger" title="Удалить"
                        onclick="return confirm('Вы уверены, что хотите удалить этого пользователя? Это действие нельзя отменить!')">
                    <i class="fas fa-trash"></i>
                </button>
            </form>
            <button type="button" class="btn btn-sm btn-info" title="Изменить роль"
                    onclick="showRoleModal(${user.id}, '${user.full_name}', '${user.role}')">
                <i class="fas fa-user-cog"></i>
            </button>
        `;
    }
    
    row.innerHTML = `
        <td>${user.id}</td>
        <td>${user.telegram_id}</td>
        <td>${user.full_name}</td>
        <td>${user.phone_number}</td>
        <td>${user.apartment || '-'}</td>
        <td>${roleHtml}</td>
        <td>${statusHtml}</td>
        <td>${formatDateTime(user.created_at)}</td>
        <td class="actions">${actionsHtml}</td>
    `;
    
    return row;
}

// Обработчик скролла
window.addEventListener('scroll', () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
        loadMoreUsers();
    }
});

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Добавляем обработчики событий для новых форм
    document.addEventListener('submit', function(e) {
        if (e.target.tagName === 'FORM') {
            const statusInput = e.target.querySelector('input[name="status"]');
            if (statusInput) {
                const status = statusInput.value;
                const action = status === 'approved' ? 'подтвердить' : 'отклонить';
                
                if (!confirm(`Вы уверены, что хотите ${action} этого пользователя?`)) {
                    e.preventDefault();
                }
            }
        }
    });
    
    // Обработчики для поиска
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.getElementById('clear-search');
    const clearSearchResultsBtn = document.getElementById('clear-search-results');
    
    let searchTimeout;
    
    // Поиск с задержкой (debounce)
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const value = this.value;
        
        if (value.trim()) {
            clearSearchBtn.style.display = 'block';
            searchTimeout = setTimeout(() => {
                searchUsers(value);
            }, 500); // Задержка 500ms
        } else {
            clearSearchBtn.style.display = 'none';
            clearSearch();
        }
    });
    
    // Очистка поиска по кнопке
    clearSearchBtn.addEventListener('click', clearSearch);
    clearSearchResultsBtn.addEventListener('click', clearSearch);
    
    // Очистка поиска по Escape
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            clearSearch();
        }
    });
});

</script>
{% endblock %}
